databases:
  - name: mediremind-db
    databaseName: mediremind
    user: mediremind
    plan: free
    region: oregon

services:
  # Backend Django Service (Free Tier)
  - type: web
    name: mediremind-backend
    runtime: python
    buildCommand: "bash build.sh"
    startCommand: "gunicorn mediremind_backend.wsgi:application --bind 0.0.0.0:$PORT"
    plan: free
    region: oregon
    branch: main
    healthCheckPath: /health/
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: mediremind-db
          property: connectionString
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "false"
      - key: ENVIRONMENT
        value: "production"
      - key: REDIS_URL
        value: "redis://default:oE1Gh8TkVwGkuihbKt43XrQeZVTLbl4p@redis-12735.crce204.eu-west-2-3.ec2.redns.redis-cloud.com:12735/0"
      - key: FRONTEND_URL
        fromService:
          type: web
          name: mediremind-frontend
          property: url

  # Frontend React Service (Free Static Site)
  - type: web
    name: mediremind-frontend
    runtime: static
    buildCommand: cd staff-portal && npm ci && npx vite build
    staticPublishPath: staff-portal/dist
    pullRequestPreviewsEnabled: false
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: mediremind-backend
          property: url
      - key: REACT_APP_API_BASE_URL
        fromService:
          type: web
          name: mediremind-backend
          property: url